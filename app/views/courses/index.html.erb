<%# app/views/courses/index.html.erb %>

<div class="container mx-auto px-4 py-8 space-y-12">
  <section class="space-y-4">
    <h1 class="text-4xl font-bold">Explore Courses</h1>
    <p class="text-xl text-gray-700">
      Enhance your skills with high-quality courses from top experts
    </p>
  </section>

  <section class="space-y-6 bg-white p-6 rounded-lg shadow-md">
    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
      <div class="w-full md:w-auto flex flex-col sm:flex-row gap-4 items-center">
        <div class="relative w-full sm:w-96">
          <%= form_with url: courses_path, method: :get, local: true, class: "relative" do |f| %>
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-600"></i>
          <%= f.text_field :search, placeholder: "Search for courses...", class: "pl-10 bg-white border border-gray-300 rounded-md w-full py-2 px-3 focus:border-purple-500 focus:outline-none", value: params[:search] %>
          <% end %>
        </div>
        <button data-bs-toggle="modal" data-bs-target="#filterModal" class="w-full sm:w-auto border border-gray-300 rounded-md py-2 px-4 flex items-center">
          <i class="fas fa-filter mr-2"></i> Advanced Filters
        </button>
      </div>
      <div class="w-full md:w-64 space-y-2">
        <label for="price-range" class="text-sm font-medium text-gray-700">
          Price: <span id="min-price">0</span>đ - <span id="max-price">1,000,000</span>đ
        </label>
        <div class="slider-container">
          <%= range_field_tag :price_min, params[:price_min] || 0, min: 0, max: 1000000, step: 50000, class: "w-full", data: { controller: "slider" } %>
          <%= range_field_tag :price_max, params[:price_max] || 1000000, min: 0, max: 1000000, step: 50000, class: "w-full", data: { controller: "slider" } %>
        </div>
      </div>
    </div>
  </section>

  <section class="space-y-4">
    <h2 class="text-2xl font-semibold">Popular Categories</h2>
    <div class="flex flex-wrap gap-2">
      <%= link_to "All", courses_path(params.permit(:search, :price_min, :price_max).except(:category)), class: "px-4 py-2 rounded-md #{params[:category].blank? ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 border border-gray-300'}" %>

      <% Category.all.each do |category| %>
      <%= link_to category.name, courses_path(params.permit(:search, :price_min, :price_max).merge(category: category.name)),
            class: "px-4 py-2 rounded-md #{params[:category] == category.name ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 border border-gray-300'}" %>
      <% end %>
    </div>
  </section>

  <section class="space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-semibold">Featured Courses</h2>
      <%= link_to "View All", courses_path, class: "text-purple-600 hover:text-purple-500" %>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% @featured_courses = Course.where(status: 'published').limit(3) %>
      <% @featured_courses.each do |course| %>
      <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-300">
        <div class="relative w-full h-48">
          <% if course.thumbnail_path.present? %>
          <%= image_tag course.thumbnail_path, alt: course.title, class: "w-full h-full object-cover" %>
          <% else %>
          <%= image_tag "https://upload.wikimedia.org/wikipedia/commons/1/14/No_Image_Available.jpg", alt: course.title, class: "w-full h-full object-cover" %>
          <% end %>
          <span class="absolute top-2 left-2 bg-purple-500 text-white text-xs px-2 py-1 rounded">
            <%= course.categories.first&.name || "No Category" %>
          </span>
        </div>
        <div class="p-4">
          <h3 class="text-lg font-semibold mb-2 line-clamp-1"><%= course.title %></h3>
          <p class="text-sm text-gray-600 mb-2"><%= course.categories.first&.name || "No Category" %></p>
          <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
            <i class="fas fa-users"></i>
            <span><%= course.user.name %></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
            <i class="fas fa-book"></i>
            <span><%= course.chapters.sum { |chapter| chapter.lessons.count } %> lessons</span>
            <span>•</span>
            <i class="fas fa-clock"></i>
            <span><%= course.chapters.sum { |chapter| chapter.lessons.sum { |lesson| lesson.videos.sum(:duration) || 0 } / 60 } %> hours</span>
          </div>
          <div class="flex items-center gap-2 text-sm text-yellow-500 mb-2">
            <i class="fas fa-star"></i>
            <span>N/A</span>
            <span class="text-gray-600">(0 students)</span>
          </div>
        </div>
        <div class="p-4 bg-gray-100 border-t border-gray-300">
          <div class="flex items-center justify-between w-full">
            <div>
              <span class="text-lg font-bold"><%= number_with_delimiter(course.price) %>đ</span>
            </div>
            <%= link_to "View Details", course_path(course), class: "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded" %>
          </div>
        </div>
      </div>
      <% end %>
    </div>
  </section>

  <section class="space-y-6">
    <h2 class="text-2xl font-semibold">All Courses</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <% @courses.each do |course| %>
      <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-300">
        <div class="relative w-full h-48">
          <% if course.thumbnail_path.present? %>
          <%= image_tag course.thumbnail_path, alt: course.title, class: "w-full h-full object-cover" %>
          <% else %>
          <%= image_tag "https://upload.wikimedia.org/wikipedia/commons/1/14/No_Image_Available.jpg", alt: course.title, class: "w-full h-full object-cover" %>
          <% end %>
          <span class="absolute top-2 left-2 bg-purple-500 text-white text-xs px-2 py-1 rounded">
            <%= course.categories.first&.name || "No Category" %>
          </span>
        </div>
        <div class="p-4">
          <h3 class="text-lg font-semibold mb-2 line-clamp-1"><%= course.title %></h3>
          <div class="flex justify-between">
            <p class="text-sm text-gray-600 mb-2"><%= course.categories.first&.name || "No Category" %></p>
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
              <i class="fas fa-users"></i>
              <span><%= course.user.name %></span>
            </div>
          </div>
          <div class="flex justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
              <i class="fas fa-book"></i>
              <span><%= course.chapters.sum { |chapter| chapter.lessons.count } %></span>
              <span>•</span>
              <i class="fas fa-clock"></i>
              <span><%= course.chapters.sum { |chapter| chapter.lessons.sum { |lesson| lesson.videos.sum(:duration) || 0 } / 60 } %> hours</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-yellow-500 mb-2">
              <i class="fas fa-star"></i>
              <span>N/A</span>
              <span class="text-gray-600">(0)</span>
            </div>
          </div>
        </div>
        <div class="p-4 bg-gray-100 border-t border-gray-300">
          <div class="flex items-center justify-between w-full">
            <div>
              <span class="text-lg font-bold"><%= number_with_delimiter(course.price) %>đ</span>
            </div>
            <%= link_to "View Details", course_path(course), class: "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded" %>
          </div>
        </div>
      </div>
      <% end %>
    </div>

    <div class="pagination">
      <%= paginate @courses %>
    </div>
  </section>

  <section class="space-y-6">
    <h2 class="text-2xl font-semibold">Learning Trends</h2>
    <div class="bg-white border border-gray-300 rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold">Top Categories of Interest</h3>
          <p class="text-sm text-gray-600">Based on enrollments in the last 30 days</p>
        </div>
        <button class="border border-purple-600 text-purple-600 hover:bg-purple-600/10 px-4 py-2 rounded flex items-center">
          <i class="fas fa-chart-line mr-2"></i>
          View Detailed Report
        </button>
      </div>
      <div class="space-y-4">
        <% Category.all.each_with_index do |category, index| %>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white <%= index == 0 ? 'bg-purple-500' : 'bg-gray-300' %>">
              <%= index + 1 %>
            </div>
            <span><%= category.name %></span>
          </div>
          <div class="w-1/3 bg-gray-200 rounded-full h-2.5">
            <div class="bg-purple-600 h-2.5 rounded-full" style="width: <%= 100 - index * 15 %>%"></div>
          </div>
        </div>
        <% end %>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 class="text-2xl font-semibold">Subscribe for Updates</h2>
    <div class="bg-white border border-gray-300 rounded-lg p-6">
      <div class="flex flex-col md:flex-row items-center gap-4">
        <div class="flex-1">
          <h3 class="text-lg font-semibold mb-2">Get Notified About New Courses</h3>
          <p class="text-sm text-gray-600">
            Subscribe to receive notifications about new courses and special offers.
          </p>
        </div>
        <div class="flex-1 w-full">
          <%= form_with url: "/subscribe", method: :post, class: "flex w-full items-center space-x-2" do |f| %>
          <%= f.email_field :email, placeholder: "Enter your email", class: "flex-1 bg-white border-gray-300 rounded-md py-2 px-3 focus:border-purple-500 focus:outline-none" %>
          <%= f.submit "Subscribe", class: "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded" %>
          <% end %>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel">Filter Courses</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: courses_path, method: :get, local: true do |f| %>
      <div class="modal-body">
        <div class="mb-3">
          <label for="category" class="form-label">Category</label>
          <%= f.select :category, Category.all.map { |c| [c.name, c.name] }, { include_blank: "Select category" }, class: "form-select" %>
        </div>
        <div class="mb-3">
          <label for="level" class="form-label">Level</label>
          <select class="form-select" id="level" name="level">
            <option value="">Select level</option>
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
        <% if params[:search].present? %>
        <%= f.hidden_field :search, value: params[:search] %>
        <% end %>
        <% if params[:price_min].present? %>
        <%= f.hidden_field :price_min, value: params[:price_min] %>
        <% end %>
        <% if params[:price_max].present? %>
        <%= f.hidden_field :price_max, value: params[:price_max] %>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <%= f.submit "Apply", class: "btn btn-primary" %>
      </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :javascript do %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Price range slider functionality
    const minPriceInput = document.querySelector('input[name="price_min"]');
    const maxPriceInput = document.querySelector('input[name="price_max"]');
    const minPriceDisplay = document.getElementById('min-price');
    const maxPriceDisplay = document.getElementById('max-price');

    if (minPriceInput && maxPriceInput) {
      minPriceInput.addEventListener('input', function() {
        minPriceDisplay.textContent = parseInt(this.value).toLocaleString();
      });

      maxPriceInput.addEventListener('input', function() {
        maxPriceDisplay.textContent = parseInt(this.value).toLocaleString();
      });

      // Initialize displays
      minPriceDisplay.textContent = parseInt(minPriceInput.value).toLocaleString();
      maxPriceDisplay.textContent = parseInt(maxPriceInput.value).toLocaleString();
    }
  });
</script>
<% end %>
