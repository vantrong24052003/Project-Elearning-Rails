<div class="container mx-auto py-6 px-4 sm:px-6 lg:px-8">
  <div class="bg-gray-900 rounded-lg overflow-hidden shadow-lg">
    <div class="flex flex-col md:flex-row">
      <div class="w-full md:w-3/4">
        <!-- Video Player -->
        <div class="relative">
          <% 
            # Chuẩn bị URL cho video
            hls_url = nil
            mp4_url = nil
            thumbnail_url = nil
            
            if @video.upload.present?
              # Ưu tiên HLS
              if @video.upload.formats.include?('hls') && @video.upload.cdn_url.present?
                hls_url = @video.upload.cdn_url
                if !hls_url.include?('.m3u8')
                  hls_url = hls_url.gsub(/\.[^.]+$/, '.m3u8')
                end
              end
              
              # Dự phòng MP4
              mp4_url = @video.upload.cdn_url
              if mp4_url.include?('hls') && !mp4_url.include?('.mp4')
                mp4_url = mp4_url.gsub('/hls/', '/videos/').gsub(/\.[^.]+$/, '.mp4')
              end
              
              # Thumbnail
              thumbnail_url = @video.upload.thumbnail_path.presence || @video.thumbnail.presence
            end
          %>
          
          <div id="player-container" class="aspect-video w-full bg-black">
            <video 
              id="video-player" 
              class="w-full h-full" 
              controls 
              poster="<%= thumbnail_url %>"
              data-controller="dashboard--video-player"
              data-dashboard--video-player-video-id-value="<%= @video.id %>"
              data-dashboard--video-player-hls-url-value="<%= hls_url %>"
              data-dashboard--video-player-mp4-url-value="<%= mp4_url %>"
              data-dashboard--video-player-course-id-value="<%= @video.lesson.chapter.course_id %>">
              <% if hls_url.present? %>
                <source src="<%= hls_url %>" type="application/x-mpegURL">
              <% end %>
              <% if mp4_url.present? %>
                <source src="<%= mp4_url %>" type="video/mp4">
              <% end %>
              Trình duyệt của bạn không hỗ trợ video.
            </video>
          </div>
          
          <!-- Video Info Bar -->
          <div class="p-4 bg-gray-800 text-white">
            <div class="flex justify-between items-center">
              <h1 class="text-xl font-semibold"><%= @video.title %></h1>
              <div class="text-sm text-gray-300">
                <% if @video.upload&.duration %>
                  <%= Time.at(@video.upload.duration).utc.strftime("%H:%M:%S") %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="w-full md:w-1/4 bg-gray-800 text-white">
        <!-- Playlist -->
        <div class="p-4 border-b border-gray-700">
          <h2 class="text-lg font-medium">Nội dung khóa học</h2>
        </div>
        
        <div class="overflow-y-auto h-96">
          <% @course.chapters.order(:position).each do |chapter| %>
            <div class="p-3 border-b border-gray-700">
              <h3 class="font-medium mb-2"><%= chapter.title %></h3>
              
              <div class="space-y-2">
                <% chapter.lessons.order(:position).each do |lesson| %>
                  <div class="text-sm pl-2">
                    <h4 class="mb-1"><%= lesson.title %></h4>
                    
                    <div class="pl-3 space-y-1">
                      <% lesson.videos.order(:position).each do |video| %>
                        <div class="flex items-center py-1 px-2 rounded <%= video.id == @video.id ? 'bg-blue-900' : 'hover:bg-gray-700' %>">
                          <% if video.id == @video.id %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                          <% else %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                          <% end %>
                          <%= link_to video.title, dashboard_video_path(video), class: "text-xs #{video.id == @video.id ? 'font-semibold text-blue-400' : 'text-gray-300'}" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @video.upload&.formats&.include?('hls') %>
  <!-- HLS.js Integration - Đảm bảo HLS hoạt động trên mọi trình duyệt -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<% end %>
